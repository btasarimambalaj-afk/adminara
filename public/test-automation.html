<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AdminAra - Advanced Test & Repair Suite</title>
  <style>
    :root {
      --primary: #3498db;
      --primary-dark: #2980b9;
      --success: #27ae60;
      --danger: #e74c3c;
      --warning: #f39c12;
      --background: #f0f2f5;
      --card-bg: #ffffff;
      --text-color: #2c3e50;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--background);
      color: var(--text-color);
    }
    header {
      background: var(--text-color);
      color: #fff;
      padding: 2rem 1rem;
      text-align: center;
    }
    .btn {
      padding: 0.8rem 1.4rem;
      margin: 0.3rem;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .btn:hover { background: var(--primary-dark); transform: translateY(-2px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .section {
      margin: 1.5rem;
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .metrics {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
    }
    .metric {
      flex: 1;
      min-width: 130px;
      background: #ecf0f1;
      padding: 1rem;
      border-radius: 10px;
      text-align: center;
    }
    .metric.success { background: #d5f4e6; color: var(--success); }
    .metric.danger { background: #fadbd8; color: var(--danger); }
    .metric strong { display: block; font-size: 0.9rem; margin-bottom: 0.5rem; }
    .metric p { font-size: 1.8rem; font-weight: bold; }
    pre {
      background: #f4f4f4;
      padding: 1rem;
      border-radius: 8px;
      overflow-x: auto;
      max-height: 400px;
      font-size: 0.85rem;
    }
    .hidden { display: none; }
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 1000;
    }
    .dialog {
      width: 100%;
      max-width: 680px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .dialog header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      background: #111827;
      color: #fff;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }
    .dialog header h3 { margin: 0; font-size: 1.1rem; }
    .dialog .content {
      padding: 1.5rem 1.25rem;
      max-height: 65vh;
      overflow: auto;
    }
    .dialog footer {
      padding: 0.8rem 1.25rem;
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
      border-top: 1px solid #eee;
    }
    .link {
      background: transparent;
      color: var(--primary);
      border: none;
      cursor: pointer;
      text-decoration: underline;
    }
    .chip {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      background: #eef6ff;
      color: #1d4ed8;
      font-size: 0.75rem;
      margin-right: 0.35rem;
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-left: 0.5rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @media (max-width: 768px) {
      .section { margin: 1rem; padding: 1rem; }
      .btn { font-size: 0.85rem; padding: 0.6rem 1rem; }
    }
  </style>
</head>
<body>
  <div id="modal" class="hidden"></div>
  
  <header>
    <h1>🧪 AdminAra - Advanced Test & Repair Suite</h1>
    <p>Kapsamlı sistem sağlık kontrolü ve otomatik onarım</p>
  </header>

  <div class="section">
    <h2>🛠️ Test Kontrolleri</h2>
    <button class="btn" id="runAllBtn">▶️ Tüm Testleri Çalıştır</button>
    <button class="btn" id="clearBtn">🗑️ Temizle</button>
    <button class="btn" id="aiExplainBtn">🧠 Akıllı Raporlama</button>
    <button class="btn" id="scheduleBtn">⏰ Zamanlı Test Kur</button>
    <button class="btn" id="tgBtn">📨 Telegram Ayarları</button>
    <button class="btn" id="exportJsonBtn">📥 Export JSON</button>
    <button class="btn" id="exportMdBtn">📄 Export MD</button>
  </div>

  <div class="section metrics">
    <div class="metric success">
      <strong>Başarılı</strong>
      <p id="metricPassed">0</p>
    </div>
    <div class="metric danger">
      <strong>Başarısız</strong>
      <p id="metricFailed">0</p>
    </div>
    <div class="metric">
      <strong>Toplam</strong>
      <p id="metricTotal">0</p>
    </div>
    <div class="metric">
      <strong>Süre</strong>
      <p id="metricDuration">0s</p>
    </div>
    <div class="metric">
      <strong>Kapsam</strong>
      <p id="metricCoverage">0%</p>
    </div>
  </div>

  <div class="section">
    <h2>📂 Test Kategorileri (8 PART - 39 Tests)</h2>
    <ul style="list-style: none; padding: 0;">
      <li>✅ PART-1: Temel Kontroller (6 tests)</li>
      <li>✅ PART-2: API Endpoints (5 tests)</li>
      <li>✅ PART-3: Bağlantı Testleri (4 tests)</li>
      <li>✅ PART-4: Güvenlik Testleri (5 tests)</li>
      <li>✅ PART-5: WebRTC Detaylı (8 tests)</li>
      <li>✅ PART-6: Performans (4 tests)</li>
      <li>✅ PART-7: UI/UX (4 tests)</li>
      <li>✅ PART-8: State Management (3 tests)</li>
    </ul>
  </div>

  <div class="section">
    <h2>📝 Test Logları</h2>
    <div>
      <button class="btn" data-filter="all">Tümü</button>
      <button class="btn" data-filter="success">Başarılı</button>
      <button class="btn" data-filter="error">Hata</button>
      <button class="btn" data-filter="info">Bilgi</button>
    </div>
    <pre id="logArea">Test logları burada görünecek...</pre>
  </div>

  <script>
    const state = {
      passed: 0,
      failed: 0,
      total: 0,
      duration: '0s',
      coverage: '0%',
      logs: [],
      rawLogs: ''
    };

    function log(msg, type = 'info') {
      const timestamp = new Date().toLocaleTimeString('tr-TR');
      const entry = `[${timestamp}] [${type.toUpperCase()}] ${msg}`;
      state.logs.push({ msg: entry, type });
      state.rawLogs += entry + '\n';
      updateLogArea();
    }

    function updateLogArea() {
      document.getElementById('logArea').textContent = state.rawLogs || 'Test logları burada görünecek...';
    }

    function updateMetrics() {
      document.getElementById('metricPassed').textContent = state.passed;
      document.getElementById('metricFailed').textContent = state.failed;
      document.getElementById('metricTotal').textContent = state.total;
      document.getElementById('metricDuration').textContent = state.duration;
      document.getElementById('metricCoverage').textContent = state.coverage;
    }

    async function runAllTests() {
      const btn = document.getElementById('runAllBtn');
      btn.disabled = true;
      btn.innerHTML = '⏳ Çalıştırılıyor...<span class="spinner"></span>';
      
      log('Test suite başlatılıyor...', 'info');
      const start = Date.now();
      
      try {
        const res = await fetch('/api/test/run', { method: 'POST' });
        const data = await res.json();
        
        state.passed = data.summary.passed;
        state.failed = data.summary.failed;
        state.total = data.summary.total;
        state.duration = data.summary.duration;
        state.coverage = data.summary.coverage;
        
        log(`✅ Testler tamamlandı: ${state.passed} başarılı, ${state.failed} başarısız`, 'success');
        updateMetrics();
      } catch (e) {
        log(`❌ Test çalıştırma hatası: ${e.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '▶️ Tüm Testleri Çalıştır';
      }
    }

    function parseLogs(raw) {
      const lines = String(raw || '')
        .split(/\n/)
        .map(l => l.trim())
        .filter(Boolean);

      const issues = [];
      const hints = new Set();
      const kw = [
        ['reconnect', 'Socket reconnect için disconnect sonrası otomatik bağlantıyı etkinleştirin.'],
        ['token', 'Admin Session için token yenileme (refresh) akışı ekleyin.'],
        ['csp', "CSP için script-src 'self' + nonce/sha256 kullanın."],
        ['cors', 'CORS için wildcard yerine whitelist domain politikaları tanımlayın.'],
        ['ice', 'ICE için STUN/TURN fallback ve ICE restart akışını kontrol edin.'],
        ['bandwidth', 'Adaptif bitrate (ABR) ve codec seçimini güncelleyin.'],
        ['memory', 'Detach edilmiş DOM ve event listener temizliği yapın.'],
        ['accessibility', 'A11y için ARIA etiketleri ve kontrast oranlarını doğrulayın.']
      ];

      lines.forEach(l => {
        if (/\b(fail|error|hata|failed|❌)\b/i.test(l)) issues.push(l);
        kw.forEach(([k, msg]) => { if (l.toLowerCase().includes(k)) hints.add(msg); });
      });

      return { issues, hints: [...hints] };
    }larını doğrulayın.']
      ];
      
      lines.forEach(l => {
        if (/(fail|error|hata|failed|❌)/i.test(l)) issues.push(l);
        keywords.forEach(([k, msg]) => {
          if (l.toLowerCase().includes(k)) hints.add(msg);
        });
      });
      
      return { issues, hints: Array.from(hints) };
    }

    function generateSmartReport() {
      const { issues, hints } = parseLogs(state.rawLogs);
      return `# 🧠 Akıllı Rapor

**İstatistikler**
- Başarılı: ${state.passed}
- Başarısız: ${state.failed}
- Toplam: ${state.total}
- Süre: ${state.duration}
- Kapsam: ${state.coverage}

---

## ❌ Tespit Edilen Sorunlar
${issues.length ? issues.map(i => `- ${i}`).join('\n') : '- Sorun tespit edilmedi.'}

## ✨ Önerilen Düzeltmeler
${hints.length ? hints.map(h => `- ${h}`).join('\n') : '- Öneri bulunamadı.'}`;
    }

    function openModal(title, html) {
      const host = document.getElementById('modal');
      host.className = 'overlay';
      host.innerHTML = `
        <div class="dialog">
          <header>
            <h3>${title}</h3>
            <button class="link" id="closeModal">Kapat</button>
          </header>
          <div class="content">${html}</div>
          <footer>
            <button class="btn" id="modalAction">Tamam</button>
          </footer>
        </div>`;
      document.getElementById('closeModal').onclick = closeModal;
      document.getElementById('modalAction').onclick = closeModal;
    }

    function closeModal() {
      document.getElementById('modal').className = 'hidden';
      document.getElementById('modal').innerHTML = '';
    }

    async function notifyTelegram(text) {
      try {
        const res = await fetch('/api/telegram/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        if (!res.ok) throw new Error('Telegram gönderimi başarısız');
        return true;
      } catch (e) {
        throw new Error(e.message);
      }
    }

    // Event Listeners
    document.getElementById('runAllBtn').onclick = runAllTests;
    
    document.getElementById('clearBtn').onclick = () => {
      state.logs = [];
      state.rawLogs = '';
      state.passed = state.failed = state.total = 0;
      state.duration = '0s';
      state.coverage = '0%';
      updateLogArea();
      updateMetrics();
      log('Loglar temizlendi', 'info');
    };

    document.getElementById('aiExplainBtn').onclick = () => {
      const report = generateSmartReport();
      const { hints } = parseLogs(state.rawLogs);
      const chips = hints.map(() => '<span class="chip">✓ Öneri</span>').join(' ');
      openModal('🧠 Akıllı Raporlama', `${chips}<pre>${report}</pre>`);
    };

    document.getElementById('scheduleBtn').onclick = () => {
      const times = JSON.parse(localStorage.getItem('schedule_times') || '["10:00","14:00","20:00","23:00"]');
      const form = `
        <p>Günlük otomatik test saatleri (Europe/Istanbul):</p>
        ${['10:00','14:00','20:00','23:00'].map(t => `
          <label style="display:block;margin:0.5rem 0;">
            <input type="checkbox" name="times" value="${t}" ${times.includes(t)?'checked':''}/> ${t}
          </label>
        `).join('')}
        <p style="margin-top:1rem;font-size:0.85rem;color:#6b7280;">
          Not: Backend scheduler kullanın (npm run scheduler)
        </p>`;
      openModal('⏰ Zamanlı Test Kur', form);
    };

    document.getElementById('tgBtn').onclick = () => {
      const form = `
        <p>Telegram bildirim ayarları:</p>
        <p style="margin:1rem 0;font-size:0.9rem;color:#6b7280;">
          Backend proxy kullanılıyor: <code>/api/telegram/send</code>
        </p>
        <p style="font-size:0.85rem;">
          .env dosyasında TELEGRAM_BOT_TOKEN ve TELEGRAM_ADMIN_CHAT_ID ayarlayın.
        </p>
        <button class="btn" id="tgTest" style="margin-top:1rem;">Test Mesajı Gönder</button>`;
      openModal('📨 Telegram Ayarları', form);
      setTimeout(() => {
        document.getElementById('tgTest').onclick = async () => {
          try {
            await notifyTelegram('Test bildirimi: AdminAra Test Suite');
            alert('✅ Telegram mesajı gönderildi!');
          } catch (e) {
            alert('❌ Gönderilemedi: ' + e.message);
          }
        };
      }, 100);
    };

    document.getElementById('exportJsonBtn').onclick = () => {
      const data = { summary: state, logs: state.logs };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'test-results.json';
      a.click();
      log('JSON export tamamlandı', 'info');
    };

    document.getElementById('exportMdBtn').onclick = () => {
      const report = generateSmartReport();
      const blob = new Blob([report], { type: 'text/markdown' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'akilli-rapor.md';
      a.click();
      log('Markdown export tamamlandı', 'info');
    };

    // Log filtering
    document.querySelectorAll('[data-filter]').forEach(btn => {
      btn.onclick = () => {
        const filter = btn.dataset.filter;
        if (filter === 'all') {
          updateLogArea();
        } else {
          const filtered = state.logs
            .filter(l => l.type === filter)
            .map(l => l.msg)
            .join('\n');
          document.getElementById('logArea').textContent = filtered || 'Filtre sonucu bulunamadı';
        }
      };
    });

    // Initial log
    log('Test suite hazır. "Tüm Testleri Çalıştır" butonuna tıklayın.', 'info');
  </script>
</body>
</html>
