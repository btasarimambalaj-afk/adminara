<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Test Suite - AdminAra</title>
  <link rel="stylesheet" href="css/test-suite.css">
  <style>
    .repair-section {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      padding: 30px;
      border-radius: 15px;
      margin: 20px 0;
      color: white;
    }
    .repair-button {
      background: white;
      color: #f5576c;
      border: none;
      padding: 15px 30px;
      border-radius: 50px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      transition: transform 0.2s;
    }
    .repair-button:hover { transform: translateY(-2px); }
    .diagnostic-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .diagnostic-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }
    .status-healthy { background: #27ae60; }
    .status-warning { background: #f39c12; }
    .status-error { background: #e74c3c; }
    .status-unknown { background: #95a5a6; }
    .fix-actions {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .fix-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      background: #3498db;
      color: white;
      transition: background 0.2s;
    }
    .fix-btn:hover { background: #2980b9; }
    .fix-btn.danger { background: #e74c3c; }
    .fix-btn.danger:hover { background: #c0392b; }
    .summary-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      grid-column: 1 / -1;
    }
    .summary-stats {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin: 20px 0;
    }
    .stat-item {
      text-align: center;
      padding: 15px 25px;
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
    }
    .stat-value {
      display: block;
      font-size: 32px;
      font-weight: bold;
    }
    .stat-label {
      display: block;
      font-size: 14px;
      margin-top: 5px;
    }
    .summary-actions {
      text-align: center;
      margin-top: 15px;
    }
    .status-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      margin: 10px 0;
    }
    .status-badge.status-healthy { background: #d4edda; color: #155724; }
    .status-badge.status-warning { background: #fff3cd; color: #856404; }
    .status-badge.status-error { background: #f8d7da; color: #721c24; }
    .status-badge.status-unknown { background: #e2e3e5; color: #383d41; }
    .details p { margin: 5px 0; font-size: 14px; color: #555; }
    .header-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 20px 0;
      justify-content: center;
    }
    .btn-primary, .btn-secondary {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102,126,234,0.4);
    }
    .btn-secondary {
      background: white;
      color: #333;
      border: 2px solid #e0e0e0;
    }
    .btn-secondary:hover {
      background: #f5f5f5;
      border-color: #667eea;
      color: #667eea;
    }
    .ai-analysis {
      padding: 20px;
    }
    .ai-analysis h3 {
      color: #667eea;
      margin-bottom: 15px;
    }
    .ai-analysis h4 {
      color: #764ba2;
      margin: 15px 0 10px 0;
    }
    .ai-analysis .summary {
      background: #f0f4ff;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
      margin: 10px 0;
    }
    .ai-analysis ul {
      list-style: none;
      padding: 0;
    }
    .ai-analysis li {
      padding: 8px 0;
      padding-left: 25px;
      position: relative;
    }
    .ai-analysis li:before {
      content: '•';
      position: absolute;
      left: 10px;
      color: #667eea;
      font-weight: bold;
    }
    .ai-analysis .issue {
      background: #fff;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    .ai-analysis .issue strong {
      display: block;
      margin-bottom: 8px;
      font-size: 16px;
    }
    .ai-analysis .issue p {
      margin: 5px 0;
      color: #666;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔧 AdminAra - Advanced Test & Repair Suite</h1>
    <p class="subtitle">Kapsamlı sistem sağlık kontrolü ve entegrasyon testleri</p>
    
    <!-- REPAIR & DIAGNOSTIC SECTION -->
    <div class="repair-section">
      <h2>🛠️ System Repair & Diagnostics</h2>
      <p>Sisteminizdeki sorunları otomatik tespit edin ve düzeltin</p>
      <button class="repair-button" onclick="runFullDiagnostics()">🔍 Tam Tanılama Başlat</button>
    </div>
    
    <div id="diagnosticsResult" class="diagnostic-panel" style="display: none;">
      <!-- Dynamic diagnostic cards will be inserted here -->
    </div>
    
    <div class="header-actions">
      <button class="btn-primary" id="runAll">▶️ Tüm Testleri Çalıştır</button>
      <button class="btn-primary" id="runBackend" title="Backend test runner'ı tetikle">🚀 Backend Testler</button>
      <button class="btn-secondary" id="clearBtn">🗑️ Temizle</button>
      <button class="btn-secondary" id="aiAnalyze" title="AI ile test sonuçlarını analiz et">🧠 AI Analiz</button>
      <button class="btn-secondary" id="snapshotBtn" title="Mevcut durumu kaydet">📸 Snapshot</button>
      <button class="btn-secondary" id="rollbackBtn" title="Önceki duruma dön">↩️ Rollback</button>
      <button class="btn-secondary" id="telegramBtn" title="Telegram ayarları">📨 Telegram</button>
      <button class="btn-secondary" id="scheduleBtn" title="Zamanlı test ayarları">⏰ Zamanlama</button>
      <button class="btn-secondary" id="exportMD" title="Markdown formatında rapor">📄 Export MD</button>
      <button class="btn-secondary" id="exportCSV" title="CSV formatında rapor">📊 Export CSV</button>
      <button class="btn-secondary" id="exportJSON" title="JSON formatında rapor">📁 Export JSON</button>
      <button class="btn-secondary" id="exportZIP" title="Tüm raporlar ZIP">📦 Export ZIP</button>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" id="progress"></div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="passed">0</div>
        <div class="stat-label">Başarılı</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="failed">0</div>
        <div class="stat-label">Başarısız</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="total">0</div>
        <div class="stat-label">Toplam</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="duration">0s</div>
        <div class="stat-label">Süre</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="coverage">0%</div>
        <div class="stat-label">Kapsam</div>
      </div>
    </div>

    <div class="test-category">
      <div class="category-header">
        <h2>🔌 Temel Kontroller</h2>
        <span class="category-badge">6 test</span>
      </div>
      <div class="test-grid">
        <button class="test-btn" data-test="socket">Socket.io</button>
        <button class="test-btn" data-test="webrtc">WebRTC</button>
        <button class="test-btn" data-test="fetch">Fetch API</button>
        <button class="test-btn" data-test="browser">Browser</button>
        <button class="test-btn" data-test="localStorage">LocalStorage</button>
        <button class="test-btn" data-test="serviceWorker">Service Worker</button>
      </div>
    </div>

    <div class="test-category">
      <div class="category-header">
        <h2>🌐 API Endpoints</h2>
        <span class="category-badge">5 test</span>
      </div>
      <div class="test-grid">
        <button class="test-btn" data-test="health">Health Check</button>
        <button class="test-btn" data-test="ice">ICE Servers</button>
        <button class="test-btn" data-test="metrics">Metrics</button>
        <button class="test-btn" data-test="adminSession">Admin Session</button>
        <button class="test-btn" data-test="otpRequest">OTP Request</button>
      </div>
    </div>

    <div class="test-category">
      <div class="category-header">
        <h2>🔗 Bağlantı Testleri</h2>
        <span class="category-badge">4 test</span>
      </div>
      <div class="test-grid">
        <button class="test-btn" data-test="socketConnect">Socket Bağlantı</button>
        <button class="test-btn" data-test="ping">Ping Test</button>
        <button class="test-btn" data-test="socketReconnect">Socket Reconnect</button>
        <button class="test-btn" data-test="socketEvents">Socket Events</button>
      </div>
    </div>

    <div class="test-category">
      <div class="category-header">
        <h2>🔐 Güvenlik Testleri</h2>
        <span class="category-badge">5 test</span>
      </div>
      <div class="test-grid">
        <button class="test-btn" data-test="otpMetrics">OTP Metrics</button>
        <button class="test-btn" data-test="rateLimiter">Rate Limiter</button>
        <button class="test-btn" data-test="otpLockout">OTP Lockout</button>
        <button class="test-btn" data-test="csp">CSP Headers</button>
        <button class="test-btn" data-test="cors">CORS Policy</button>
      </div>
    </div>

    <div class="test-category">
      <div class="category-header">
        <h2>🎥 WebRTC Detaylı</h2>
        <span class="category-badge">8 test</span>
      </div>
      <div class="test-grid">
        <button class="test-btn" data-test="peerConnection">Peer Connection</button>
        <button class="test-btn" data-test="iceGathering">ICE Gathering</button>
        <button class="test-btn" data-test="mediaStream">Media Stream</button>
        <button class="test-btn" data-test="reconnect">Reconnect Logic</button>
        <button class="test-btn" data-test="turnServer">TURN Server</button>
        <button class="test-btn" data-test="dataChannel">Data Channel</button>
        <button class="test-btn" data-test="iceRestart">ICE Restart</button>
        <button class="test-btn" data-test="perfectNegotiation">Perfect Negotiation</button>
      </div>
    </div>

    <div class="test-category">
      <div class="category-header">
        <h2>📊 Performans Testleri</h2>
        <span class="category-badge">4 test</span>
      </div>
      <div class="test-grid">
        <button class="test-btn" data-test="latency">Latency Test</button>
        <button class="test-btn" data-test="bandwidth">Bandwidth Test</button>
        <button class="test-btn" data-test="memoryUsage">Memory Usage</button>
        <button class="test-btn" data-test="cpuUsage">CPU Usage</button>
      </div>
    </div>

    <div class="test-category">
      <div class="category-header">
        <h2>🎨 UI/UX Testleri</h2>
        <span class="category-badge">4 test</span>
      </div>
      <div class="test-grid">
        <button class="test-btn" data-test="responsive">Responsive Design</button>
        <button class="test-btn" data-test="accessibility">Accessibility</button>
        <button class="test-btn" data-test="darkMode">Dark Mode</button>
        <button class="test-btn" data-test="animations">Animations</button>
      </div>
    </div>

    <div class="test-category">
      <div class="category-header">
        <h2>🔄 State Management</h2>
        <span class="category-badge">3 test</span>
      </div>
      <div class="test-grid">
        <button class="test-btn" data-test="stateStore">State Store</button>
        <button class="test-btn" data-test="sessionPersist">Session Persist</button>
        <button class="test-btn" data-test="queueSystem">Queue System</button>
      </div>
    </div>

    <div class="logs-section">
      <div class="logs-header">
        <h2>📝 Test Logları</h2>
        <div class="log-filters">
          <button class="filter-btn active" data-filter="all">Tümü</button>
          <button class="filter-btn" data-filter="success">Başarılı</button>
          <button class="filter-btn" data-filter="error">Hata</button>
          <button class="filter-btn" data-filter="info">Bilgi</button>
        </div>
      </div>
      <div id="logs"></div>
    </div>
  </div>

  <script>
    // Dynamic base URL detection
    const baseURL = window.location.protocol + '//' + window.location.host;
    window.baseURL = baseURL;
  </script>
  <script src="./socket.io/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="js/test-ai-analyzer.js"></script>
  <script src="js/test-snapshot.js"></script>
  <script src="js/test-exporter.js"></script>
  <script src="js/test-diagnostics.js"></script>
  <script src="js/test-repair.js"></script>
  <script src="js/tests.js"></script>
  <script>
    // Initialize advanced features
    const aiAnalyzer = new AITestAnalyzer();
    const snapshotManager = new SnapshotManager();
    const testExporter = new TestExporter();
    let testResults = { total: 0, passed: 0, failed: 0, categories: {}, failures: [] };

    // AI Analysis
    document.getElementById('aiAnalyze').addEventListener('click', () => {
      if (testResults.failures.length === 0) {
        alert('✅ Tüm testler başarılı! Analiz edilecek hata yok.');
        return;
      }
      const analysis = aiAnalyzer.analyze(testResults.failures);
      const report = aiAnalyzer.generateReport(analysis);
      
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;';
      modal.innerHTML = `<div style="background:white;padding:30px;border-radius:15px;max-width:800px;max-height:80vh;overflow-y:auto;">${report}<button onclick="this.parentElement.parentElement.remove()" style="margin-top:20px;padding:10px 20px;background:#3498db;color:white;border:none;border-radius:5px;cursor:pointer;">Kapat</button></div>`;
      document.body.appendChild(modal);
    });

    // Snapshot
    document.getElementById('snapshotBtn').addEventListener('click', () => {
      const name = prompt('Snapshot adı:', `Test ${new Date().toLocaleTimeString('tr-TR')}`);
      if (name) {
        const snapshot = snapshotManager.createSnapshot(name);
        alert(`✅ Snapshot kaydedildi: ${snapshot.name}`);
      }
    });

    // Rollback
    document.getElementById('rollbackBtn').addEventListener('click', () => {
      const snapshots = snapshotManager.listSnapshots();
      if (snapshots.length === 0) {
        alert('⚠️ Kayıtlı snapshot yok. Önce bir snapshot oluşturun.');
        return;
      }
      const list = snapshots.map((s, i) => `${i+1}. ${s.name} (${new Date(s.timestamp).toLocaleString('tr-TR')})`).join('\n');
      const choice = prompt(`Hangi snapshot'a dönmek istersiniz?\n\n${list}\n\nNumara girin:`);
      if (choice) {
        const index = parseInt(choice) - 1;
        if (snapshots[index]) {
          if (confirm(`${snapshots[index].name} snapshot'ına dönülecek. Sayfa yenilenecek. Onaylıyor musunuz?`)) {
            snapshotManager.rollback(snapshots[index].id);
          }
        }
      }
    });

    // Export handlers
    document.getElementById('exportMD').addEventListener('click', () => {
      testExporter.exportMarkdown(testResults);
    });

    document.getElementById('exportCSV').addEventListener('click', () => {
      testExporter.exportCSV(testResults);
    });

    document.getElementById('exportJSON').addEventListener('click', () => {
      testExporter.exportJSON(testResults);
    });

    document.getElementById('exportZIP').addEventListener('click', async () => {
      const logs = Array.from(document.querySelectorAll('#logs .log-entry')).map(e => e.textContent);
      await testExporter.exportZIP(testResults, logs);
    });

    // Update testResults when tests run
    window.updateTestResults = (results) => {
      testResults = results;
    };

    // Backend test runner
    document.getElementById('runBackend').addEventListener('click', async () => {
      const btn = document.getElementById('runBackend');
      btn.disabled = true;
      btn.textContent = '⏳ Çalıştırılıyor...';
      
      try {
        const res = await fetch((window.baseURL || '') + '/api/test/run', { method: 'POST' });
        const data = await res.json();
        
        document.getElementById('passed').textContent = data.summary.passed;
        document.getElementById('failed').textContent = data.summary.failed;
        document.getElementById('total').textContent = data.summary.total;
        document.getElementById('duration').textContent = data.summary.duration;
        document.getElementById('coverage').textContent = data.summary.coverage;
        
        alert(`✅ Backend testler tamamlandı!\n\nPassed: ${data.summary.passed}\nFailed: ${data.summary.failed}\nTotal: ${data.summary.total}`);
      } catch (e) {
        alert('❌ Backend test hatası: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = '🚀 Backend Testler';
      }
    });

    // Telegram settings
    document.getElementById('telegramBtn').addEventListener('click', () => {
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;';
      modal.innerHTML = `
        <div style="background:white;padding:30px;border-radius:15px;max-width:500px;">
          <h3 style="margin-top:0;">📨 Telegram Ayarları</h3>
          <p style="color:#666;font-size:14px;">Backend proxy kullanılıyor: <code>/api/telegram/send</code></p>
          <p style="margin:15px 0;font-size:14px;">.env dosyasında ayarlayın:</p>
          <pre style="background:#f5f5f5;padding:15px;border-radius:8px;font-size:13px;">TELEGRAM_BOT_TOKEN=your_token
TELEGRAM_ADMIN_CHAT_ID=your_chat_id</pre>
          <button onclick="testTelegram()" style="margin:15px 5px 0 0;padding:10px 20px;background:#3498db;color:white;border:none;border-radius:5px;cursor:pointer;">Test Mesajı Gönder</button>
          <button onclick="this.parentElement.parentElement.remove()" style="margin:15px 0 0 5px;padding:10px 20px;background:#95a5a6;color:white;border:none;border-radius:5px;cursor:pointer;">Kapat</button>
        </div>`;
      document.body.appendChild(modal);
    });

    window.testTelegram = async () => {
      try {
        const res = await fetch((window.baseURL || '') + '/api/telegram/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: 'Test bildirimi: AdminAra Test Suite' })
        });
        if (res.ok) alert('✅ Telegram mesajı gönderildi!');
        else alert('❌ Gönderilemedi: ' + res.statusText);
      } catch (e) {
        alert('❌ Hata: ' + e.message);
      }
    };

    // Schedule settings
    document.getElementById('scheduleBtn').addEventListener('click', () => {
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;';
      modal.innerHTML = `
        <div style="background:white;padding:30px;border-radius:15px;max-width:500px;">
          <h3 style="margin-top:0;">⏰ Zamanlı Test Ayarları</h3>
          <p style="color:#666;font-size:14px;">Backend cron server kullanılıyor</p>
          <p style="margin:15px 0;font-size:14px;"><strong>Zamanlanmış saatler (Europe/Istanbul):</strong></p>
          <ul style="list-style:none;padding:0;">
            <li style="padding:8px;background:#f0f4ff;margin:5px 0;border-radius:5px;">✅ 10:00</li>
            <li style="padding:8px;background:#f0f4ff;margin:5px 0;border-radius:5px;">✅ 14:00</li>
            <li style="padding:8px;background:#f0f4ff;margin:5px 0;border-radius:5px;">✅ 20:00</li>
            <li style="padding:8px;background:#f0f4ff;margin:5px 0;border-radius:5px;">✅ 23:00</li>
          </ul>
          <p style="margin:15px 0;font-size:13px;color:#666;">Başlatmak için: <code>npm run cron</code></p>
          <button onclick="this.parentElement.parentElement.remove()" style="margin-top:15px;padding:10px 20px;background:#3498db;color:white;border:none;border-radius:5px;cursor:pointer;">Kapat</button>
        </div>`;
      document.body.appendChild(modal);
    });
  </script>
</body>
</html>
