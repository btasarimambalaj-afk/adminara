<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>HayDay Admin Paneli</title>
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="css/components/admin.css" />
  <link rel="stylesheet" href="css/mobile.css" />
  <link rel="stylesheet" href="css/accessibility.css" />
  <link rel="stylesheet" href="css/toast.css" />
</head>
<body>
  <!-- Karşılama Ekranı - OTP -->
  <section class="auth-card" id="welcomeScreen">
    <header>
      <h1>Admin girişi</h1>
      <p>Telegram üzerinden aldığınız tek seferlik kodla doğrulayın.</p>
    </header>
    <ol class="auth-steps">
      <li>Admin botundan kod iste.</li>
      <li>Kodu 60 saniye içinde gir.</li>
      <li>Panel otomatik açılacak.</li>
    </ol>
    <div class="otp-fieldset">
      <button id="requestOtpBtn" class="btn-primary">Kod gönder</button>
      <div class="otp-inputs" id="otpInputSection" hidden>
        <label for="otpInput">6 haneli kod</label>
        <input id="otpInput" inputmode="numeric" maxlength="6" />
        <button id="verifyOtpBtn" class="btn-primary" disabled>Panele gir</button>
      </div>
      <p id="otpError" class="inline-error" hidden></p>
      <p id="otpSuccess" style="color:#4CAF50;display:none;margin:0;">Şifre gönderildi!</p>
    </div>
  </section>

  <!-- Admin Paneli -->
  <div id="adminPanel" class="container" style="display:none;">
    <div class="admin-queue-panel" id="adminQueuePanel" style="display:none;">
      <div class="admin-queue-title">📋 Müşteri Bilgileri</div>
      
      <div class="admin-current-call" id="adminCurrentCall" style="display:none;">
        <div class="admin-current-call-title">Aktif Görüşme</div>
        <div class="admin-current-call-name" id="adminCurrentName">-</div>
        <div class="admin-current-call-duration" id="adminCurrentDuration">00:00</div>
      </div>
      
      <div class="admin-queue-list" id="adminQueueList">
        <div class="admin-queue-empty">Sırada bekleyen yok</div>
      </div>
      
      <div class="admin-stats">
        <div class="admin-stat">
          <div class="admin-stat-value" id="adminTotalCalls">0</div>
          <div class="admin-stat-label">Toplam Görüşme</div>
        </div>
        <div class="admin-stat">
          <div class="admin-stat-value" id="adminQueueCount">0</div>
          <div class="admin-stat-label">Sırada</div>
        </div>
      </div>
    </div>
    
    <div class="phone-interface admin-interface">
      <div class="status-bar">
        <span>HayDay Admin Paneli</span>
        <button id="refreshButton" class="refresh-btn" title="Sayfayı Yenile">🔄</button>
      </div>

      <div class="video-container" id="videoContainer">
        <video id="remoteVideo" autoplay playsinline></video>
        <video id="localVideo" autoplay playsinline muted></video>
        
        <button id="exitFullscreenBtn" class="exit-fullscreen-btn" title="Tam Ekrandan Çık">⛶</button>
        <button id="diagnosticsToggle" class="diagnostics-toggle" title="Diagnostics">📊</button>
        
        <div id="diagnosticsPanel" class="diagnostics-panel hidden">
          <div class="diagnostics-title">📊 Call Diagnostics</div>
          <div class="diagnostics-row">
            <span class="diagnostics-label">RTT:</span>
            <span class="diagnostics-value" id="diagRTT">--</span>
          </div>
          <div class="diagnostics-row">
            <span class="diagnostics-label">Packet Loss:</span>
            <span class="diagnostics-value" id="diagPacketLoss">--</span>
          </div>
          <div class="diagnostics-row">
            <span class="diagnostics-label">Jitter:</span>
            <span class="diagnostics-value" id="diagJitter">--</span>
          </div>
          <div class="diagnostics-row">
            <span class="diagnostics-label">Connection:</span>
            <span class="diagnostics-value" id="diagConnection">--</span>
          </div>
          <div class="diagnostics-row">
            <span class="diagnostics-label">ICE State:</span>
            <span class="diagnostics-value" id="diagICE">--</span>
          </div>
        </div>
        
        <div id="callInfo" class="call-info-center hidden">
          <div class="info-line" id="customerNameDisplay">👤 Müşteri</div>
          <div class="info-line" id="callTime">--:--</div>
          <div class="info-line" id="callDuration">00:00</div>
        </div>
        
        
        <div id="waiting-message" class="status-message hidden">
          <div class="spinner"></div>
          <p>Müşteri bekleniyor...</p>
        </div>
      </div>

      <div class="controls">
        <div class="control-buttons hidden" id="controlButtons">
          <button id="muteButton" class="btn control-btn" title="Mikrofon Açık">🎙️</button>
          <button id="cameraButton" class="btn control-btn active" title="Kamera Kapalı">📵</button>
          <button id="speakerButton" class="btn control-btn" title="Hoparlör Kapalı">🔈</button>
          <button id="fullscreenButton" class="btn control-btn" title="Tam Ekran">⛶</button>
          <button id="restartICEButton" class="btn control-btn" title="Bağlantıyı Yeniden Başlat">🔄</button>
          <button id="audioOnlyButton" class="btn control-btn" title="Sadece Sese Geç">🔊</button>
          <button id="testButton" class="btn secondary" title="Test">🧪</button>
          <button id="endButton" class="btn end-btn">Bitir</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="js/toast.js"></script>
  <script src="js/warmup.js"></script>
  <script src="js/accessibility.js"></script>
  <script src="js/perfect-negotiation.js"></script>
  <script src="js/connection-monitor.js"></script>
  <script src="js/helpers.js"></script>
  <script src="js/webrtc.js"></script>
  <script>
    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(() => console.log('✅ Service Worker registered'))
        .catch((err) => console.error('❌ Service Worker registration failed:', err));
    }
  </script>
  <script>
    class AdminApp {
      constructor() {
        this.socket = io({
          reconnection: true,
          reconnectionDelay: 1000,
          reconnectionDelayMax: 5000,
          reconnectionAttempts: Infinity,
          transports: ['websocket', 'polling']
        });
        this.webRTCManager = new WebRTCManager();
        this.authenticated = false;
        this.timer = Helpers.createTimer();
        this.init();
      }
      
      async init() {
        this.setupWelcomeEvents();
        this.setupEvents();
        await this.checkHttpSession();
      }
      
      async checkHttpSession() {
        try {
          const r = await fetch('/admin/session/verify');
          if (r.ok) {
            console.log('✅ Valid cookie session');
            this.authenticated = true;
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('waiting-message').classList.remove('hidden');
            document.getElementById('controlButtons').classList.remove('hidden');
            const ok = await this.webRTCManager.start(this.socket, false);
            if (ok) {
              console.log('✅ Admin WebRTC stream ready');
            }
            // Room'a katıl
            this.socket.emit('room:join', { isAdmin: true });
            console.log('✅ Admin joining room...');
            
            // Peer connection'u room:joined sonrası oluştur
          }
        } catch (e) {
          console.log('❌ No valid session');
        }
        const refreshBtn = document.getElementById('refreshButton');
        if (refreshBtn) refreshBtn.onclick = () => window.location.reload();
      }
      

      
      setupWelcomeEvents() {
        const requestBtn = document.getElementById('requestOtpBtn');
        const verifyBtn = document.getElementById('verifyOtpBtn');
        const otpInput = document.getElementById('otpInput');
        const otpError = document.getElementById('otpError');
        const otpSuccess = document.getElementById('otpSuccess');
        const otpSection = document.getElementById('otpInputSection');
        
        otpInput.oninput = () => {
          verifyBtn.disabled = otpInput.value.trim().length !== 6;
        };
        
        requestBtn.onclick = async () => {
          requestBtn.disabled = true;
          requestBtn.textContent = 'Gönderiliyor...';
          try {
            const response = await fetch('/admin/otp/request', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ adminId: 'admin' })
            });
            console.log('OTP request response:', response.status);
            if (response.ok) {
              otpSuccess.style.display = 'block';
              otpSection.style.display = 'block';
              requestBtn.style.display = 'none';
              otpInput.focus();
            } else {
              console.error('OTP request failed:', response.status);
              otpError.textContent = 'Şifre gönderilemedi';
              otpError.style.display = 'block';
              requestBtn.disabled = false;
              requestBtn.textContent = 'Şifre İste 📱';
            }
          } catch (e) {
            console.error('OTP request error:', e);
            otpError.textContent = 'Bağlantı hatası';
            otpError.style.display = 'block';
            requestBtn.disabled = false;
            requestBtn.textContent = 'Şifre İste 📱';
          }
        };
        

        

        

        

        

        

        

        

        
        const handleVerify = async () => {
          const code = otpInput.value.trim();
          if (!/^\d{6}$/.test(code)) {
            otpError.textContent = 'Lütfen 6 haneli şifre girin';
            otpError.style.display = 'block';
            return;
          }
          verifyBtn.disabled = true;
          verifyBtn.textContent = 'Kontrol ediliyor...';
          try {
            const r = await fetch('/admin/otp/verify', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ adminId: 'admin', code })
            });
            if (r.status === 204) {
              this.authenticated = true;
              document.getElementById('welcomeScreen').style.display = 'none';
              document.getElementById('adminPanel').style.display = 'block';
              document.getElementById('waiting-message').classList.remove('hidden');
              document.getElementById('controlButtons').classList.remove('hidden');
              const ok = await this.webRTCManager.start(this.socket, false);
              if (ok) {
                this.webRTCManager.createPeerConnection();
                console.log('✅ Admin WebRTC ready');
              }
              this.socket.emit('room:join', { isAdmin: true });
              console.log('✅ Admin joined room');
            } else {
              otpError.textContent = 'Hatalı şifre!';
              otpError.style.display = 'block';
              otpInput.value = '';
              verifyBtn.disabled = false;
              verifyBtn.textContent = 'Giriş Yap 🔓';
            }
          } catch (e) {
            otpError.textContent = 'Hata oluştu';
            otpError.style.display = 'block';
            verifyBtn.disabled = false;
            verifyBtn.textContent = 'Giriş Yap 🔓';
          }
        };
        
        verifyBtn.onclick = handleVerify;
        otpInput.onkeypress = (e) => {
          if (e.key === 'Enter' && otpInput.value.trim().length === 6) handleVerify();
        };
      }
      
      setupEvents() {

        
        this.socket.on('disconnect', (reason) => {
          console.log('🔴 Socket disconnected:', reason);
          if (typeof window.showToast === 'function') {
            window.showToast('warning', 'Bağlantı koptu, yeniden bağlanılıyor...');
          }
        });
        
        this.socket.on('reconnect', async (attemptNumber) => {
          console.log('🟢 Socket reconnected after', attemptNumber, 'attempts');
          if (typeof window.showToast === 'function') {
            window.showToast('success', 'Bağlantı yeniden kuruldu');
          }
          if (this.authenticated) {
            try {
              const r = await fetch('/admin/session/verify');
              if (r.ok) {
                this.socket.emit('room:join', { isAdmin: true });
                console.log('✅ Re-joined room after reconnect');
              } else {
                this.authenticated = false;
                window.location.reload();
              }
            } catch (e) {
              this.authenticated = false;
              window.location.reload();
            }
          }
        });
        
        this.socket.on('reconnect_attempt', (attemptNumber) => {
          console.log('🔄 Reconnect attempt:', attemptNumber);
        });
        
        this.socket.on('reconnect_error', (error) => {
          console.error('❌ Reconnect error:', error.message);
        });
        
        this.socket.on('reconnect_failed', () => {
          console.error('❌ Reconnect failed permanently');
          if (typeof window.showToast === 'function') {
            window.showToast('error', 'Bağlantı kurulamadı, sayfa yenileniyor...');
          }
          setTimeout(() => window.location.reload(), 3000);
        });
        
        this.socket.on('room:joined', (data) => {
          if (data.role === 'admin') {
            console.log('✅ Admin room:joined event received');
            // Şimdi peer connection oluştur
            if (!this.webRTCManager.peerConnection) {
              this.webRTCManager.createPeerConnection();
              console.log('✅ Admin peer connection created, waiting for customer...');
            }
          }
        });
        
        this.socket.on('room:user:joined', async (data) => {
          if (data.role === 'customer') {
            console.log('👤 Müşteri odaya katıldı:', data.customerName);
            document.getElementById('waiting-message').classList.add('hidden');
            document.getElementById('callInfo').classList.remove('hidden');
            
            // Show customer name
            if (data.customerName) {
              const nameDisplay = document.getElementById('customerNameDisplay');
              nameDisplay.textContent = `👤 ${data.customerName}`;
            }
            
            this.timer.start();
            
            // Peer connection kontrolü
            if (this.webRTCManager.peerConnection) {
              const pc = this.webRTCManager.peerConnection;
              console.log('✅ Admin peer connection hazır');
              console.log('🔄 Signaling state:', pc.signalingState);
              console.log('🔄 Connection state:', pc.connectionState);
              console.log('🔄 ICE state:', pc.iceConnectionState);
              
              // Perfect Negotiation onnegotiationneeded ile otomatik başlayacak
              // Eğer başlamazsa, manuel trigger
              if (pc.signalingState === 'stable') {
                console.log('🔄 Waiting for onnegotiationneeded...');
              }
            } else {
              console.error('❌ Admin peer connection yok!');
            }
          }
        });
        
        this.socket.on('customer:name:updated', (data) => {
          console.log('👤 Müşteri ismi güncellendi:', data.customerName);
          const nameDisplay = document.getElementById('customerNameDisplay');
          if (nameDisplay && data.customerName) {
            nameDisplay.textContent = `👤 ${data.customerName}`;
          }
        });
        
        this.socket.on('room:timeout', () => {
          console.log('Room timeout');
          // Session'u koruyoruz, sadece waiting mesajı göster
          document.getElementById('waiting-message').classList.remove('hidden');
          document.getElementById('callInfo').classList.add('hidden');
          this.timer.stop();
        });
        
        // Setup control buttons using shared helper
        Helpers.setupControlButtons(this.webRTCManager);
        
        document.getElementById('endButton').onclick = () => {
          console.log('📴 Admin müşteriyi bitirdi, bağlantı korunuyor...');
          this.timer.stop();
          
          // Müşteriye call:ended gönder
          this.socket.emit('call:end');
          
          // Admin bağlı kalır, sadece waiting mesajı göster
          document.getElementById('waiting-message').classList.remove('hidden');
          document.getElementById('callInfo').classList.add('hidden');
          
          // Admin için peer connection'u KORU (persistent)
          console.log('✅ Peer connection korunuyor, yeni müşteri için hazır');
        };
        
        this.socket.on('call:ended', () => {
          console.log('📞 Müşteri görüşmeyi bitirdi');
          this.timer.stop();
          
          // Admin için peer connection'u KORU (persistent)
          console.log('✅ Peer connection korunuyor, yeni müşteri için hazır');
          
          // Admin bağlı kalır, yeni müşteri bekler
          document.getElementById('waiting-message').classList.remove('hidden');
          document.getElementById('callInfo').classList.add('hidden');
        });
        document.getElementById('diagnosticsToggle').onclick = () => {
          const panel = document.getElementById('diagnosticsPanel');
          panel.classList.toggle('hidden');
        };
        
        document.getElementById('restartICEButton').onclick = async () => {
          console.log('🔄 Manual ICE restart triggered');
          if (this.webRTCManager.peerConnection) {
            await this.webRTCManager.handleConnectionFailure();
            if (typeof window.showToast === 'function') {
              window.showToast('info', 'Bağlantı yeniden başlatılıyor...');
            }
          }
        };
        
        document.getElementById('audioOnlyButton').onclick = () => {
          console.log('🔊 Switching to audio-only mode');
          const senders = this.webRTCManager.peerConnection?.getSenders() || [];
          senders.forEach(sender => {
            if (sender.track && sender.track.kind === 'video') {
              sender.track.enabled = false;
              console.log('📵 Video disabled');
            }
          });
          if (typeof window.showToast === 'function') {
            window.showToast('info', 'Sadece ses moduna geçildi');
          }
        };
        
        setInterval(() => {
          if (this.webRTCManager.connectionMonitor) {
            const stats = this.webRTCManager.connectionMonitor.getStats();
            const rttEl = document.getElementById('diagRTT');
            const plEl = document.getElementById('diagPacketLoss');
            const jitterEl = document.getElementById('diagJitter');
            const connEl = document.getElementById('diagConnection');
            const iceEl = document.getElementById('diagICE');
            
            if (rttEl && stats.rtt) {
              const rtt = Math.round(stats.rtt * 1000);
              rttEl.textContent = rtt + 'ms';
              rttEl.className = 'diagnostics-value ' + (rtt < 100 ? 'good' : rtt < 300 ? 'warning' : 'error');
            }
            
            if (plEl) {
              const pl = stats.packetLoss.toFixed(1);
              plEl.textContent = pl + '%';
              plEl.className = 'diagnostics-value ' + (pl < 2 ? 'good' : pl < 5 ? 'warning' : 'error');
            }
            
            if (jitterEl && stats.latency) {
              const jitter = Math.round(stats.latency * 1000);
              jitterEl.textContent = jitter + 'ms';
              jitterEl.className = 'diagnostics-value ' + (jitter < 30 ? 'good' : jitter < 100 ? 'warning' : 'error');
            }
            
            if (connEl) {
              connEl.textContent = stats.quality;
              connEl.className = 'diagnostics-value ' + (stats.quality === 'good' ? 'good' : stats.quality === 'fair' ? 'warning' : 'error');
            }
            
            if (iceEl && this.webRTCManager.peerConnection) {
              const iceState = this.webRTCManager.peerConnection.iceConnectionState;
              iceEl.textContent = iceState;
              iceEl.className = 'diagnostics-value ' + (iceState === 'connected' ? 'good' : iceState === 'checking' ? 'warning' : 'error');
            }
          }
        }, 2000);
        
        document.getElementById('testButton').onclick = () => window.open('/test-suite.html', '_blank');
        document.getElementById('refreshButton').onclick = () => window.location.reload();
      }
    }
    
    new AdminApp();
  </script>
</body>
</html>