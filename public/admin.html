<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>HayDay Admin Paneli</title>
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="css/components/hero.css" />
  <link rel="stylesheet" href="css/components/admin.css" />
  <link rel="stylesheet" href="css/mobile.css" />
  <link rel="stylesheet" href="css/accessibility.css" />
  <link rel="stylesheet" href="css/toast.css" />
</head>
<body>
  <!-- Admin GiriÅŸ EkranÄ± -->
  <div class="hero-wrapper" id="welcomeScreen">
    <div class="brand">
      <div class="brand-badge">ğŸ”</div>
      <div class="brand-name">Admin Paneli</div>
    </div>

    <div class="card">
      <p>Telegram Ã¼zerinden aldÄ±ÄŸÄ±nÄ±z 6 haneli kodu girin.</p>
      <button id="requestOtpBtn" class="ready">Kod GÃ¶nder</button>
      
      <div id="otpInputSection" class="hidden">
        <input id="otpInput" type="text" inputmode="numeric" maxlength="6" placeholder="6 haneli kod" />
        <button id="verifyOtpBtn" disabled>Panele Gir</button>
      </div>
      
      <p id="otpError" class="hidden error-text"></p>
      <p id="otpSuccess" class="hidden success-text">Kod gÃ¶nderildi!</p>
    </div>

    <footer>
      <button onclick="window.location.reload()" class="btn secondary">ğŸ”„ Yenile</button>
    </footer>
  </div>

  <!-- Admin GÃ¶rÃ¼ÅŸme Paneli -->
  <div id="adminPanel" class="container" style="display:none;">
    <div class="phone-interface admin-interface">
      <div class="status-bar">
        <span>HayDay Admin Paneli</span>
        <button id="refreshButton" class="refresh-btn" title="SayfayÄ± Yenile">ğŸ”„</button>
      </div>

      <div class="video-container">
        <video id="remoteVideo" autoplay playsinline></video>
        <video id="localVideo" autoplay playsinline muted></video>
        
        <button id="exitFullscreenBtn" class="exit-fullscreen-btn" title="Tam Ekrandan Ã‡Ä±k">â›¶</button>
        <button id="diagnosticsToggle" class="diagnostics-toggle" title="Diagnostics">ğŸ“Š</button>
        
        <div id="diagnosticsPanel" class="diagnostics-panel hidden">
          <div class="diagnostics-title">ğŸ“Š BaÄŸlantÄ± Durumu</div>
          <div class="diagnostics-row">
            <span class="diagnostics-label">RTT:</span>
            <span class="diagnostics-value" id="diagRTT">--</span>
          </div>
          <div class="diagnostics-row">
            <span class="diagnostics-label">Packet Loss:</span>
            <span class="diagnostics-value" id="diagPacketLoss">--</span>
          </div>
          <div class="diagnostics-row">
            <span class="diagnostics-label">Jitter:</span>
            <span class="diagnostics-value" id="diagJitter">--</span>
          </div>
          <div class="diagnostics-row">
            <span class="diagnostics-label">BaÄŸlantÄ±:</span>
            <span class="diagnostics-value" id="diagConnection">--</span>
          </div>
          <div class="diagnostics-row">
            <span class="diagnostics-label">ICE:</span>
            <span class="diagnostics-value" id="diagICE">--</span>
          </div>
        </div>
        
        <div id="callInfo" class="call-info-center hidden">
          <div class="info-line" id="customerNameDisplay">ğŸ‘¤ MÃ¼ÅŸteri</div>
          <div class="info-line" id="callTime">--:--</div>
          <div class="info-line" id="callDuration">00:00</div>
        </div>
        
        <div id="waiting-message" class="status-message hidden">
          <div class="spinner"></div>
          <p>MÃ¼ÅŸteri bekleniyor...</p>
        </div>
      </div>

      <div class="controls">
        <button id="endButton" class="btn end-btn hidden">ğŸ“´ Bitir</button>
        
        <div class="control-buttons hidden" id="controlButtons">
          <button id="muteButton" class="btn control-btn" title="Mikrofon">ğŸ™ï¸</button>
          <button id="cameraButton" class="btn control-btn active" title="Kamera">ğŸ“µ</button>
          <button id="speakerButton" class="btn control-btn" title="HoparlÃ¶r">ğŸ”ˆ</button>
          <button id="fullscreenButton" class="btn control-btn" title="Tam Ekran">â›¶</button>
          <button id="restartICEButton" class="btn control-btn" title="Yeniden BaÅŸlat">ğŸ”„</button>
          <button id="testButton" class="btn control-btn" title="Test">ğŸ§ª</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="js/toast.js"></script>
  <script src="js/warmup.js"></script>
  <script src="js/accessibility.js"></script>
  <script src="js/perfect-negotiation.js"></script>
  <script src="js/connection-monitor.js"></script>
  <script src="js/helpers.js"></script>
  <script src="js/webrtc.js"></script>
  <script>
    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(() => console.log('âœ… Service Worker registered'))
        .catch((err) => console.error('âŒ Service Worker registration failed:', err));
    }
  </script>
  <script>
    class AdminApp {
      constructor() {
        this.socket = io({
          reconnection: true,
          reconnectionDelay: 1000,
          reconnectionDelayMax: 5000,
          reconnectionAttempts: Infinity,
          transports: ['websocket', 'polling']
        });
        this.webRTCManager = new WebRTCManager();
        this.authenticated = false;
        this.timer = Helpers.createTimer();
        this.init();
      }
      
      async init() {
        this.setupWelcomeEvents();
        this.setupEvents();
        await this.checkHttpSession();
      }
      
      async checkHttpSession() {
        try {
          const r = await fetch('/admin/session/verify');
          if (r.ok) {
            console.log('âœ… Valid cookie session');
            this.authenticated = true;
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('waiting-message').classList.remove('hidden');
            document.getElementById('controlButtons').classList.remove('hidden');
            const ok = await this.webRTCManager.start(this.socket, false);
            if (ok) {
              console.log('âœ… Admin WebRTC stream ready');
            }
            // Room'a katÄ±l
            this.socket.emit('room:join', { isAdmin: true });
            console.log('âœ… Admin joining room...');
            
            // Peer connection'u room:joined sonrasÄ± oluÅŸtur
          }
        } catch (e) {
          console.log('âŒ No valid session');
        }
        const refreshBtn = document.getElementById('refreshButton');
        if (refreshBtn) refreshBtn.onclick = () => window.location.reload();
      }
      

      
      setupWelcomeEvents() {
        const requestBtn = document.getElementById('requestOtpBtn');
        const verifyBtn = document.getElementById('verifyOtpBtn');
        const otpInput = document.getElementById('otpInput');
        const otpError = document.getElementById('otpError');
        const otpSuccess = document.getElementById('otpSuccess');
        const otpSection = document.getElementById('otpInputSection');
        
        otpInput.oninput = () => {
          const ok = otpInput.value.trim().length === 6;
          verifyBtn.disabled = !ok;
          verifyBtn.setAttribute('aria-disabled', String(!ok));
          verifyBtn.classList.toggle('ready', ok);
        };
        
        requestBtn.onclick = async () => {
          requestBtn.disabled = true;
          requestBtn.textContent = 'GÃ¶nderiliyor...';
          try {
            const response = await fetch('/admin/otp/request', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ adminId: 'admin' })
            });
            console.log('OTP request response:', response.status);
            if (response.ok) {
              otpSuccess.style.display = 'block';
              otpSection.style.display = 'block';
              requestBtn.classList.add('ready');
              requestBtn.style.display = 'none';
              otpInput.focus();
            } else {
              console.error('OTP request failed:', response.status);
              otpError.textContent = 'Åifre gÃ¶nderilemedi';
              otpError.style.display = 'block';
              requestBtn.disabled = false;
              requestBtn.textContent = 'Åifre Ä°ste ğŸ“±';
            }
          } catch (e) {
            console.error('OTP request error:', e);
            otpError.textContent = 'BaÄŸlantÄ± hatasÄ±';
            otpError.style.display = 'block';
            requestBtn.disabled = false;
            requestBtn.textContent = 'Åifre Ä°ste ğŸ“±';
          }
        };
        

        

        

        

        

        

        

        

        
        const handleVerify = async () => {
          const code = otpInput.value.trim();
          if (!/^\d{6}$/.test(code)) {
            otpError.textContent = 'LÃ¼tfen 6 haneli ÅŸifre girin';
            otpError.style.display = 'block';
            return;
          }
          verifyBtn.disabled = true;
          verifyBtn.textContent = 'Kontrol ediliyor...';
          try {
            const r = await fetch('/admin/otp/verify', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ adminId: 'admin', code })
            });
            if (r.status === 204) {
              this.authenticated = true;
              document.getElementById('welcomeScreen').style.display = 'none';
              document.getElementById('adminPanel').style.display = 'block';
              document.getElementById('waiting-message').classList.remove('hidden');
              document.getElementById('controlButtons').classList.remove('hidden');
              const ok = await this.webRTCManager.start(this.socket, false);
              if (ok) {
                this.webRTCManager.createPeerConnection();
                console.log('âœ… Admin WebRTC ready');
              }
              this.socket.emit('room:join', { isAdmin: true });
              console.log('âœ… Admin joined room');
            } else {
              otpError.textContent = 'HatalÄ± ÅŸifre!';
              otpError.style.display = 'block';
              otpInput.value = '';
              verifyBtn.disabled = false;
              verifyBtn.textContent = 'GiriÅŸ Yap ğŸ”“';
            }
          } catch (e) {
            otpError.textContent = 'Hata oluÅŸtu';
            otpError.style.display = 'block';
            verifyBtn.disabled = false;
            verifyBtn.textContent = 'GiriÅŸ Yap ğŸ”“';
          }
        };
        
        verifyBtn.onclick = handleVerify;
        otpInput.onkeypress = (e) => {
          if (e.key === 'Enter' && otpInput.value.trim().length === 6) handleVerify();
        };
      }
      
      setupEvents() {

        
        this.socket.on('disconnect', (reason) => {
          console.log('ğŸ”´ Socket disconnected:', reason);
          if (typeof window.showToast === 'function') {
            window.showToast('warning', 'BaÄŸlantÄ± koptu, yeniden baÄŸlanÄ±lÄ±yor...');
          }
        });
        
        this.socket.on('reconnect', async (attemptNumber) => {
          console.log('ğŸŸ¢ Socket reconnected after', attemptNumber, 'attempts');
          if (typeof window.showToast === 'function') {
            window.showToast('success', 'BaÄŸlantÄ± yeniden kuruldu');
          }
          if (this.authenticated) {
            try {
              const r = await fetch('/admin/session/verify');
              if (r.ok) {
                this.socket.emit('room:join', { isAdmin: true });
                console.log('âœ… Re-joined room after reconnect');
              } else {
                this.authenticated = false;
                window.location.reload();
              }
            } catch (e) {
              this.authenticated = false;
              window.location.reload();
            }
          }
        });
        
        this.socket.on('reconnect_attempt', (attemptNumber) => {
          console.log('ğŸ”„ Reconnect attempt:', attemptNumber);
        });
        
        this.socket.on('reconnect_error', (error) => {
          console.error('âŒ Reconnect error:', error.message);
        });
        
        this.socket.on('reconnect_failed', () => {
          console.error('âŒ Reconnect failed permanently');
          if (typeof window.showToast === 'function') {
            window.showToast('error', 'BaÄŸlantÄ± kurulamadÄ±, sayfa yenileniyor...');
          }
          setTimeout(() => window.location.reload(), 3000);
        });
        
        this.socket.on('room:joined', (data) => {
          if (data.role === 'admin') {
            console.log('âœ… Admin room:joined event received');
            // Åimdi peer connection oluÅŸtur
            if (!this.webRTCManager.peerConnection) {
              this.webRTCManager.createPeerConnection();
              console.log('âœ… Admin peer connection created, waiting for customer...');
            }
          }
        });
        
        this.socket.on('room:user:joined', async (data) => {
          if (data.role === 'customer') {
            console.log('ğŸ‘¤ MÃ¼ÅŸteri odaya katÄ±ldÄ±:', data.customerName);
            document.getElementById('waiting-message').classList.add('hidden');
            document.getElementById('callInfo').classList.remove('hidden');
            
            // Show customer name
            if (data.customerName) {
              const nameDisplay = document.getElementById('customerNameDisplay');
              nameDisplay.textContent = `ğŸ‘¤ ${data.customerName}`;
            }
            
            this.timer.start();
            
            // Peer connection kontrolÃ¼
            if (this.webRTCManager.peerConnection) {
              const pc = this.webRTCManager.peerConnection;
              console.log('âœ… Admin peer connection hazÄ±r');
              console.log('ğŸ”„ Signaling state:', pc.signalingState);
              console.log('ğŸ”„ Connection state:', pc.connectionState);
              console.log('ğŸ”„ ICE state:', pc.iceConnectionState);
              
              // Perfect Negotiation onnegotiationneeded ile otomatik baÅŸlayacak
              // EÄŸer baÅŸlamazsa, manuel trigger
              if (pc.signalingState === 'stable') {
                console.log('ğŸ”„ Waiting for onnegotiationneeded...');
              }
            } else {
              console.error('âŒ Admin peer connection yok!');
            }
          }
        });
        
        this.socket.on('customer:name:updated', (data) => {
          console.log('ğŸ‘¤ MÃ¼ÅŸteri ismi gÃ¼ncellendi:', data.customerName);
          const nameDisplay = document.getElementById('customerNameDisplay');
          if (nameDisplay && data.customerName) {
            nameDisplay.textContent = `ğŸ‘¤ ${data.customerName}`;
          }
        });
        
        this.socket.on('room:timeout', () => {
          console.log('Room timeout');
          // Session'u koruyoruz, sadece waiting mesajÄ± gÃ¶ster
          document.getElementById('waiting-message').classList.remove('hidden');
          document.getElementById('callInfo').classList.add('hidden');
          this.timer.stop();
        });
        
        // Setup control buttons using shared helper
        Helpers.setupControlButtons(this.webRTCManager);
        
        document.getElementById('endButton').onclick = () => {
          console.log('ğŸ“´ Admin mÃ¼ÅŸteriyi bitirdi, baÄŸlantÄ± korunuyor...');
          this.timer.stop();
          
          // MÃ¼ÅŸteriye call:ended gÃ¶nder
          this.socket.emit('call:end');
          
          // Admin baÄŸlÄ± kalÄ±r, sadece waiting mesajÄ± gÃ¶ster
          document.getElementById('waiting-message').classList.remove('hidden');
          document.getElementById('callInfo').classList.add('hidden');
          
          // Admin iÃ§in peer connection'u KORU (persistent)
          console.log('âœ… Peer connection korunuyor, yeni mÃ¼ÅŸteri iÃ§in hazÄ±r');
        };
        
        this.socket.on('call:ended', () => {
          console.log('ğŸ“ MÃ¼ÅŸteri gÃ¶rÃ¼ÅŸmeyi bitirdi');
          this.timer.stop();
          
          // Admin iÃ§in peer connection'u KORU (persistent)
          console.log('âœ… Peer connection korunuyor, yeni mÃ¼ÅŸteri iÃ§in hazÄ±r');
          
          // Admin baÄŸlÄ± kalÄ±r, yeni mÃ¼ÅŸteri bekler
          document.getElementById('waiting-message').classList.remove('hidden');
          document.getElementById('callInfo').classList.add('hidden');
        });
        document.getElementById('diagnosticsToggle').onclick = () => {
          const panel = document.getElementById('diagnosticsPanel');
          panel.classList.toggle('hidden');
        };
        
        document.getElementById('restartICEButton').onclick = async () => {
          console.log('ğŸ”„ Manual ICE restart triggered');
          if (this.webRTCManager.peerConnection) {
            await this.webRTCManager.handleConnectionFailure();
            if (typeof window.showToast === 'function') {
              window.showToast('info', 'BaÄŸlantÄ± yeniden baÅŸlatÄ±lÄ±yor...');
            }
          }
        };
        
        setInterval(() => {
          if (this.webRTCManager.connectionMonitor) {
            const stats = this.webRTCManager.connectionMonitor.getStats();
            const rttEl = document.getElementById('diagRTT');
            const plEl = document.getElementById('diagPacketLoss');
            const jitterEl = document.getElementById('diagJitter');
            const connEl = document.getElementById('diagConnection');
            const iceEl = document.getElementById('diagICE');
            
            if (rttEl && stats.rtt) {
              const rtt = Math.round(stats.rtt * 1000);
              rttEl.textContent = rtt + 'ms';
              rttEl.className = 'diagnostics-value ' + (rtt < 100 ? 'good' : rtt < 300 ? 'warning' : 'error');
            }
            
            if (plEl) {
              const pl = stats.packetLoss.toFixed(1);
              plEl.textContent = pl + '%';
              plEl.className = 'diagnostics-value ' + (pl < 2 ? 'good' : pl < 5 ? 'warning' : 'error');
            }
            
            if (jitterEl && stats.latency) {
              const jitter = Math.round(stats.latency * 1000);
              jitterEl.textContent = jitter + 'ms';
              jitterEl.className = 'diagnostics-value ' + (jitter < 30 ? 'good' : jitter < 100 ? 'warning' : 'error');
            }
            
            if (connEl) {
              connEl.textContent = stats.quality;
              connEl.className = 'diagnostics-value ' + (stats.quality === 'good' ? 'good' : stats.quality === 'fair' ? 'warning' : 'error');
            }
            
            if (iceEl && this.webRTCManager.peerConnection) {
              const iceState = this.webRTCManager.peerConnection.iceConnectionState;
              iceEl.textContent = iceState;
              iceEl.className = 'diagnostics-value ' + (iceState === 'connected' ? 'good' : iceState === 'checking' ? 'warning' : 'error');
            }
          }
        }, 2000);
        
        const testBtn = document.getElementById('testButton');
        const refreshBtn = document.getElementById('refreshButton');
        
        if (testBtn) testBtn.onclick = () => window.open('/test-suite.html', '_blank');
        if (refreshBtn) refreshBtn.onclick = () => window.location.reload();
      }
    }
    
    new AdminApp();
  </script>
</body>
</html>