# Render Deployment Fix

## Yapılan Değişiklikler

### 1. render.yaml Optimizasyonu
- ✅ `buildCommand`: `npm install` → `npm ci --only=production` (daha hızlı ve güvenilir)
- ✅ `startCommand`: `npm start` → `node server.js` (direkt başlatma)
- ✅ `healthCheckPath`: `/ready` → `/health` (daha kapsamlı kontrol)

### 2. server.js Düzeltmeleri
- ✅ `COOKIE_SECRET` fallback eklendi (eksik olsa bile çalışır)
- ✅ Server binding: `0.0.0.0` adresi eklendi (Render için zorunlu)

## Render Dashboard'da Yapılması Gerekenler

### Environment Variables Kontrolü
Render Dashboard → Environment → Environment Variables bölümünde şunları kontrol edin:

```bash
# ZORUNLU
NODE_ENV=production
PORT=3000

# Render otomatik generate edecek (sync: false olanlar)
SESSION_SECRET=<auto-generated>
COOKIE_SECRET=<auto-generated>
JWT_SECRET=<auto-generated>
```

### Opsiyonel (Önerilir)
```bash
TELEGRAM_BOT_TOKEN=<your-token>
TELEGRAM_ADMIN_CHAT_ID=<your-chat-id>
TURN_SERVER_URL=<your-turn-server>
REDIS_URL=<your-redis-url>
```

## Deployment Adımları

1. **Git Push**
```bash
git add .
git commit -m "fix: Render deployment configuration"
git push origin main
```

2. **Render'da Manuel Deploy** (opsiyonel)
- Render Dashboard → Manual Deploy → Deploy latest commit

3. **Health Check**
```bash
# 60 saniye bekleyin, sonra:
curl https://adminara.onrender.com/health
```

## Sorun Devam Ederse

### Render Logs Kontrolü
```
Render Dashboard → Logs
```

Şu hataları arayın:
- `Error: listen EADDRINUSE` → Port zaten kullanımda
- `COOKIE_SECRET not set` → Environment variable eksik
- `Cannot find module` → npm install başarısız
- `ECONNREFUSED` → Redis/Telegram bağlantı hatası

### Manuel Test
```bash
# Local test
PORT=3000 NODE_ENV=production node server.js

# Health check
curl http://localhost:3000/health
```

## Beklenen Sonuç

✅ Deployment başarılı
✅ Health check: 200 OK
✅ URL erişilebilir: https://adminara.onrender.com
✅ Admin panel: https://adminara.onrender.com/admin

## Render Free Plan Limitasyonları

⚠️ **Önemli**: Render Free Plan'de:
- 15 dakika inaktivite sonrası sleep mode
- İlk istek 30-60 saniye gecikme (cold start)
- 512MB RAM limiti
- Aylık 750 saat çalışma süresi

### Keep-Alive Çözümü
Uygulama zaten keep-alive mekanizmasına sahip:
- Her 4 dakikada bir `/health` endpoint'ine ping
- `PING_INTERVAL=240000` (4 dakika)
- `RENDER_EXTERNAL_URL` otomatik set edilir

## Troubleshooting

### Hata: "Application failed to respond"
**Çözüm**: Health check timeout artırın
```yaml
# render.yaml
healthCheckPath: /health
# Render Dashboard → Settings → Health Check Timeout: 30s
```

### Hata: "Build failed"
**Çözüm**: Node version kontrolü
```json
// package.json
"engines": {
  "node": ">=18.0.0"
}
```

### Hata: "Port already in use"
**Çözüm**: PORT env variable kontrolü
```javascript
// server.js
const PORT = process.env.PORT || 3000;
```

## Support

Sorun devam ederse:
1. Render logs'u paylaşın
2. `curl https://adminara.onrender.com/health` çıktısını paylaşın
3. GitHub Actions logs'u kontrol edin
